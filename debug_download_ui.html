<!DOCTYPE html>
<html>
<head>
    <title>Download UI Debug</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f5f5f5; }
        .debug-box { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; }
        .error { color: red; }
        .success { color: green; }
        pre { background: #f0f0f0; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Download UI Debugging</h1>

    <div class="debug-box">
        <h2>1. Check /list-pcaps Endpoint</h2>
        <button onclick="testListPcaps()">Test API</button>
        <div id="apiResult"></div>
    </div>

    <div class="debug-box">
        <h2>2. Check JavaScript Fetch</h2>
        <button onclick="testFetch()">Test Fetch</button>
        <div id="fetchResult"></div>
    </div>

    <div class="debug-box">
        <h2>3. Simulated Download UI</h2>
        <button onclick="loadFiles()">Load Files</button>
        <div id="fileList" style="margin-top: 10px;"></div>
    </div>

    <div class="debug-box">
        <h2>4. Console Logs</h2>
        <div id="consoleLog"></div>
    </div>

    <script>
        const log = (msg, isError = false) => {
            const consoleLog = document.getElementById('consoleLog');
            const div = document.createElement('div');
            div.className = isError ? 'error' : 'success';
            div.textContent = new Date().toLocaleTimeString() + ' - ' + msg;
            consoleLog.appendChild(div);
            console.log(msg);
        };

        async function testListPcaps() {
            const result = document.getElementById('apiResult');
            result.innerHTML = '<p>Testing...</p>';

            try {
                const response = await fetch('/list-pcaps');
                const data = await response.json();

                result.innerHTML = `
                    <p class="success">‚úÖ API Response OK</p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
                log('API test successful');
            } catch (error) {
                result.innerHTML = `<p class="error">‚ùå Error: ${error.message}</p>`;
                log('API test failed: ' + error.message, true);
            }
        }

        async function testFetch() {
            const result = document.getElementById('fetchResult');
            result.innerHTML = '<p>Testing fetch...</p>';

            try {
                log('Starting fetch test...');
                const response = await fetch('/list-pcaps');
                log('Fetch response received: ' + response.status);

                const text = await response.text();
                log('Response text length: ' + text.length);

                const data = JSON.parse(text);
                log('JSON parsed successfully');

                result.innerHTML = `
                    <p class="success">‚úÖ Fetch works!</p>
                    <p>Status: ${response.status}</p>
                    <p>Files found: ${data.files ? data.files.length : 0}</p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
            } catch (error) {
                result.innerHTML = `<p class="error">‚ùå Fetch failed: ${error.message}</p>`;
                log('Fetch test failed: ' + error.message, true);
            }
        }

        async function loadFiles() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '<div>Loading files...</div>';
            log('Loading files...');

            try {
                const response = await fetch('/list-pcaps');
                log('Response status: ' + response.status);

                const data = await response.json();
                log('Data received: ' + JSON.stringify(data));

                if (data.error) {
                    fileList.innerHTML = `<div class="error">${data.error}</div>`;
                    log('API returned error: ' + data.error, true);
                    return;
                }

                if (!data.files || data.files.length === 0) {
                    fileList.innerHTML = '<div>No files available</div>';
                    log('No files found');
                    return;
                }

                log('Displaying ' + data.files.length + ' files');
                fileList.innerHTML = '';

                data.files.forEach(file => {
                    const sizeKB = (file.size / 1024).toFixed(2);
                    const sizeMB = (file.size / 1048576).toFixed(2);
                    const sizeStr = file.size < 1048576 ? `${sizeKB} KB` : `${sizeMB} MB`;

                    const date = new Date(file.modified * 1000);
                    const dateStr = date.toLocaleString();

                    const item = document.createElement('div');
                    item.style.cssText = 'background: #f0f8ff; padding: 10px; margin: 5px 0; border-radius: 5px; cursor: pointer;';
                    item.innerHTML = `
                        <div style="font-weight: bold;">üìÑ ${file.filename}</div>
                        <div style="font-size: 12px; color: #666;">
                            <span>${sizeStr}</span> | <span>${dateStr}</span>
                        </div>
                    `;

                    item.onclick = () => {
                        const downloadUrl = `/download/${encodeURIComponent(file.filename)}`;
                        log('Downloading: ' + downloadUrl);
                        const link = document.createElement('a');
                        link.href = downloadUrl;
                        link.download = file.filename;
                        link.click();
                    };

                    fileList.appendChild(item);
                });

                log('Files displayed successfully');
            } catch (error) {
                fileList.innerHTML = `<div class="error">Error: ${error.message}</div>`;
                log('Error loading files: ' + error.message, true);
                console.error('Full error:', error);
            }
        }

        // Auto-test on load
        window.addEventListener('DOMContentLoaded', () => {
            log('Page loaded, running auto-test...');
            setTimeout(() => {
                testListPcaps();
                setTimeout(() => loadFiles(), 1000);
            }, 500);
        });
    </script>
</body>
</html>
